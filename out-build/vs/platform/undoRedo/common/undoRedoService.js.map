{"version":3,"sources":["vs/platform/undoRedo/common/undoRedoService.ts"],"names":[],"mappings":"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","file":"undoRedoService.js","sourceRoot":"file:///workspace/appflow/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { onUnexpectedError } from 'vs/base/common/errors';\nimport { Disposable, IDisposable, isDisposable } from 'vs/base/common/lifecycle';\nimport { Schemas } from 'vs/base/common/network';\nimport Severity from 'vs/base/common/severity';\nimport { URI } from 'vs/base/common/uri';\nimport * as nls from 'vs/nls';\nimport { IDialogService } from 'vs/platform/dialogs/common/dialogs';\nimport { InstantiationType, registerSingleton } from 'vs/platform/instantiation/common/extensions';\nimport { INotificationService } from 'vs/platform/notification/common/notification';\nimport { IPastFutureElements, IResourceUndoRedoElement, IUndoRedoElement, IUndoRedoService, IWorkspaceUndoRedoElement, ResourceEditStackSnapshot, UndoRedoElementType, UndoRedoGroup, UndoRedoSource, UriComparisonKeyComputer } from 'vs/platform/undoRedo/common/undoRedo';\n\nconst DEBUG = false;\n\nfunction getResourceLabel(resource: URI): string {\n\treturn resource.scheme === Schemas.file ? resource.fsPath : resource.path;\n}\n\nlet stackElementCounter = 0;\n\nclass ResourceStackElement {\n\tpublic readonly id = (++stackElementCounter);\n\tpublic readonly type = UndoRedoElementType.Resource;\n\tpublic readonly actual: IUndoRedoElement;\n\tpublic readonly label: string;\n\tpublic readonly confirmBeforeUndo: boolean;\n\n\tpublic readonly resourceLabel: string;\n\tpublic readonly strResource: string;\n\tpublic readonly resourceLabels: string[];\n\tpublic readonly strResources: string[];\n\tpublic readonly groupId: number;\n\tpublic readonly groupOrder: number;\n\tpublic readonly sourceId: number;\n\tpublic readonly sourceOrder: number;\n\tpublic isValid: boolean;\n\n\tconstructor(actual: IUndoRedoElement, resourceLabel: string, strResource: string, groupId: number, groupOrder: number, sourceId: number, sourceOrder: number) {\n\t\tthis.actual = actual;\n\t\tthis.label = actual.label;\n\t\tthis.confirmBeforeUndo = actual.confirmBeforeUndo || false;\n\t\tthis.resourceLabel = resourceLabel;\n\t\tthis.strResource = strResource;\n\t\tthis.resourceLabels = [this.resourceLabel];\n\t\tthis.strResources = [this.strResource];\n\t\tthis.groupId = groupId;\n\t\tthis.groupOrder = groupOrder;\n\t\tthis.sourceId = sourceId;\n\t\tthis.sourceOrder = sourceOrder;\n\t\tthis.isValid = true;\n\t}\n\n\tpublic setValid(isValid: boolean): void {\n\t\tthis.isValid = isValid;\n\t}\n\n\tpublic toString(): string {\n\t\treturn `[id:${this.id}] [group:${this.groupId}] [${this.isValid ? '  VALID' : 'INVALID'}] ${this.actual.constructor.name} - ${this.actual}`;\n\t}\n}\n\nconst enum RemovedResourceReason {\n\tExternalRemoval = 0,\n\tNoParallelUniverses = 1\n}\n\nclass ResourceReasonPair {\n\tconstructor(\n\t\tpublic readonly resourceLabel: string,\n\t\tpublic readonly reason: RemovedResourceReason\n\t) { }\n}\n\nclass RemovedResources {\n\tprivate readonly elements = new Map<string, ResourceReasonPair>();\n\n\tpublic createMessage(): string {\n\t\tconst externalRemoval: string[] = [];\n\t\tconst noParallelUniverses: string[] = [];\n\t\tfor (const [, element] of this.elements) {\n\t\t\tconst dest = (\n\t\t\t\telement.reason === RemovedResourceReason.ExternalRemoval\n\t\t\t\t\t? externalRemoval\n\t\t\t\t\t: noParallelUniverses\n\t\t\t);\n\t\t\tdest.push(element.resourceLabel);\n\t\t}\n\n\t\tconst messages: string[] = [];\n\t\tif (externalRemoval.length > 0) {\n\t\t\tmessages.push(\n\t\t\t\tnls.localize(\n\t\t\t\t\t{ key: 'externalRemoval', comment: ['{0} is a list of filenames'] },\n\t\t\t\t\t\"The following files have been closed and modified on disk: {0}.\", externalRemoval.join(', ')\n\t\t\t\t)\n\t\t\t);\n\t\t}\n\t\tif (noParallelUniverses.length > 0) {\n\t\t\tmessages.push(\n\t\t\t\tnls.localize(\n\t\t\t\t\t{ key: 'noParallelUniverses', comment: ['{0} is a list of filenames'] },\n\t\t\t\t\t\"The following files have been modified in an incompatible way: {0}.\", noParallelUniverses.join(', ')\n\t\t\t\t));\n\t\t}\n\t\treturn messages.join('\\n');\n\t}\n\n\tpublic get size(): number {\n\t\treturn this.elements.size;\n\t}\n\n\tpublic has(strResource: string): boolean {\n\t\treturn this.elements.has(strResource);\n\t}\n\n\tpublic set(strResource: string, value: ResourceReasonPair): void {\n\t\tthis.elements.set(strResource, value);\n\t}\n\n\tpublic delete(strResource: string): boolean {\n\t\treturn this.elements.delete(strResource);\n\t}\n}\n\nclass WorkspaceStackElement {\n\tpublic readonly id = (++stackElementCounter);\n\tpublic readonly type = UndoRedoElementType.Workspace;\n\tpublic readonly actual: IWorkspaceUndoRedoElement;\n\tpublic readonly label: string;\n\tpublic readonly confirmBeforeUndo: boolean;\n\n\tpublic readonly resourceLabels: string[];\n\tpublic readonly strResources: string[];\n\tpublic readonly groupId: number;\n\tpublic readonly groupOrder: number;\n\tpublic readonly sourceId: number;\n\tpublic readonly sourceOrder: number;\n\tpublic removedResources: RemovedResources | null;\n\tpublic invalidatedResources: RemovedResources | null;\n\n\tconstructor(actual: IWorkspaceUndoRedoElement, resourceLabels: string[], strResources: string[], groupId: number, groupOrder: number, sourceId: number, sourceOrder: number) {\n\t\tthis.actual = actual;\n\t\tthis.label = actual.label;\n\t\tthis.confirmBeforeUndo = actual.confirmBeforeUndo || false;\n\t\tthis.resourceLabels = resourceLabels;\n\t\tthis.strResources = strResources;\n\t\tthis.groupId = groupId;\n\t\tthis.groupOrder = groupOrder;\n\t\tthis.sourceId = sourceId;\n\t\tthis.sourceOrder = sourceOrder;\n\t\tthis.removedResources = null;\n\t\tthis.invalidatedResources = null;\n\t}\n\n\tpublic canSplit(): this is WorkspaceStackElement & { actual: { split(): IResourceUndoRedoElement[] } } {\n\t\treturn (typeof this.actual.split === 'function');\n\t}\n\n\tpublic removeResource(resourceLabel: string, strResource: string, reason: RemovedResourceReason): void {\n\t\tif (!this.removedResources) {\n\t\t\tthis.removedResources = new RemovedResources();\n\t\t}\n\t\tif (!this.removedResources.has(strResource)) {\n\t\t\tthis.removedResources.set(strResource, new ResourceReasonPair(resourceLabel, reason));\n\t\t}\n\t}\n\n\tpublic setValid(resourceLabel: string, strResource: string, isValid: boolean): void {\n\t\tif (isValid) {\n\t\t\tif (this.invalidatedResources) {\n\t\t\t\tthis.invalidatedResources.delete(strResource);\n\t\t\t\tif (this.invalidatedResources.size === 0) {\n\t\t\t\t\tthis.invalidatedResources = null;\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tif (!this.invalidatedResources) {\n\t\t\t\tthis.invalidatedResources = new RemovedResources();\n\t\t\t}\n\t\t\tif (!this.invalidatedResources.has(strResource)) {\n\t\t\t\tthis.invalidatedResources.set(strResource, new ResourceReasonPair(resourceLabel, RemovedResourceReason.ExternalRemoval));\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic toString(): string {\n\t\treturn `[id:${this.id}] [group:${this.groupId}] [${this.invalidatedResources ? 'INVALID' : '  VALID'}] ${this.actual.constructor.name} - ${this.actual}`;\n\t}\n}\n\ntype StackElement = ResourceStackElement | WorkspaceStackElement;\n\nclass ResourceEditStack {\n\tpublic readonly resourceLabel: string;\n\tprivate readonly strResource: string;\n\tprivate _past: StackElement[];\n\tprivate _future: StackElement[];\n\tpublic locked: boolean;\n\tpublic versionId: number;\n\n\tconstructor(resourceLabel: string, strResource: string) {\n\t\tthis.resourceLabel = resourceLabel;\n\t\tthis.strResource = strResource;\n\t\tthis._past = [];\n\t\tthis._future = [];\n\t\tthis.locked = false;\n\t\tthis.versionId = 1;\n\t}\n\n\tpublic dispose(): void {\n\t\tfor (const element of this._past) {\n\t\t\tif (element.type === UndoRedoElementType.Workspace) {\n\t\t\t\telement.removeResource(this.resourceLabel, this.strResource, RemovedResourceReason.ExternalRemoval);\n\t\t\t}\n\t\t}\n\t\tfor (const element of this._future) {\n\t\t\tif (element.type === UndoRedoElementType.Workspace) {\n\t\t\t\telement.removeResource(this.resourceLabel, this.strResource, RemovedResourceReason.ExternalRemoval);\n\t\t\t}\n\t\t}\n\t\tthis.versionId++;\n\t}\n\n\tpublic toString(): string {\n\t\tconst result: string[] = [];\n\t\tresult.push(`* ${this.strResource}:`);\n\t\tfor (let i = 0; i < this._past.length; i++) {\n\t\t\tresult.push(`   * [UNDO] ${this._past[i]}`);\n\t\t}\n\t\tfor (let i = this._future.length - 1; i >= 0; i--) {\n\t\t\tresult.push(`   * [REDO] ${this._future[i]}`);\n\t\t}\n\t\treturn result.join('\\n');\n\t}\n\n\tpublic flushAllElements(): void {\n\t\tthis._past = [];\n\t\tthis._future = [];\n\t\tthis.versionId++;\n\t}\n\n\tpublic setElementsIsValid(isValid: boolean): void {\n\t\tfor (const element of this._past) {\n\t\t\tif (element.type === UndoRedoElementType.Workspace) {\n\t\t\t\telement.setValid(this.resourceLabel, this.strResource, isValid);\n\t\t\t} else {\n\t\t\t\telement.setValid(isValid);\n\t\t\t}\n\t\t}\n\t\tfor (const element of this._future) {\n\t\t\tif (element.type === UndoRedoElementType.Workspace) {\n\t\t\t\telement.setValid(this.resourceLabel, this.strResource, isValid);\n\t\t\t} else {\n\t\t\t\telement.setValid(isValid);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate _setElementValidFlag(element: StackElement, isValid: boolean): void {\n\t\tif (element.type === UndoRedoElementType.Workspace) {\n\t\t\telement.setValid(this.resourceLabel, this.strResource, isValid);\n\t\t} else {\n\t\t\telement.setValid(isValid);\n\t\t}\n\t}\n\n\tpublic setElementsValidFlag(isValid: boolean, filter: (element: IUndoRedoElement) => boolean): void {\n\t\tfor (const element of this._past) {\n\t\t\tif (filter(element.actual)) {\n\t\t\t\tthis._setElementValidFlag(element, isValid);\n\t\t\t}\n\t\t}\n\t\tfor (const element of this._future) {\n\t\t\tif (filter(element.actual)) {\n\t\t\t\tthis._setElementValidFlag(element, isValid);\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic pushElement(element: StackElement): void {\n\t\t// remove the future\n\t\tfor (const futureElement of this._future) {\n\t\t\tif (futureElement.type === UndoRedoElementType.Workspace) {\n\t\t\t\tfutureElement.removeResource(this.resourceLabel, this.strResource, RemovedResourceReason.NoParallelUniverses);\n\t\t\t}\n\t\t}\n\t\tthis._future = [];\n\t\tthis._past.push(element);\n\t\tthis.versionId++;\n\t}\n\n\tpublic createSnapshot(resource: URI): ResourceEditStackSnapshot {\n\t\tconst elements: number[] = [];\n\n\t\tfor (let i = 0, len = this._past.length; i < len; i++) {\n\t\t\telements.push(this._past[i].id);\n\t\t}\n\t\tfor (let i = this._future.length - 1; i >= 0; i--) {\n\t\t\telements.push(this._future[i].id);\n\t\t}\n\n\t\treturn new ResourceEditStackSnapshot(resource, elements);\n\t}\n\n\tpublic restoreSnapshot(snapshot: ResourceEditStackSnapshot): void {\n\t\tconst snapshotLength = snapshot.elements.length;\n\t\tlet isOK = true;\n\t\tlet snapshotIndex = 0;\n\t\tlet removePastAfter = -1;\n\t\tfor (let i = 0, len = this._past.length; i < len; i++, snapshotIndex++) {\n\t\t\tconst element = this._past[i];\n\t\t\tif (isOK && (snapshotIndex >= snapshotLength || element.id !== snapshot.elements[snapshotIndex])) {\n\t\t\t\tisOK = false;\n\t\t\t\tremovePastAfter = 0;\n\t\t\t}\n\t\t\tif (!isOK && element.type === UndoRedoElementType.Workspace) {\n\t\t\t\telement.removeResource(this.resourceLabel, this.strResource, RemovedResourceReason.ExternalRemoval);\n\t\t\t}\n\t\t}\n\t\tlet removeFutureBefore = -1;\n\t\tfor (let i = this._future.length - 1; i >= 0; i--, snapshotIndex++) {\n\t\t\tconst element = this._future[i];\n\t\t\tif (isOK && (snapshotIndex >= snapshotLength || element.id !== snapshot.elements[snapshotIndex])) {\n\t\t\t\tisOK = false;\n\t\t\t\tremoveFutureBefore = i;\n\t\t\t}\n\t\t\tif (!isOK && element.type === UndoRedoElementType.Workspace) {\n\t\t\t\telement.removeResource(this.resourceLabel, this.strResource, RemovedResourceReason.ExternalRemoval);\n\t\t\t}\n\t\t}\n\t\tif (removePastAfter !== -1) {\n\t\t\tthis._past = this._past.slice(0, removePastAfter);\n\t\t}\n\t\tif (removeFutureBefore !== -1) {\n\t\t\tthis._future = this._future.slice(removeFutureBefore + 1);\n\t\t}\n\t\tthis.versionId++;\n\t}\n\n\tpublic getElements(): IPastFutureElements {\n\t\tconst past: IUndoRedoElement[] = [];\n\t\tconst future: IUndoRedoElement[] = [];\n\n\t\tfor (const element of this._past) {\n\t\t\tpast.push(element.actual);\n\t\t}\n\t\tfor (const element of this._future) {\n\t\t\tfuture.push(element.actual);\n\t\t}\n\n\t\treturn { past, future };\n\t}\n\n\tpublic getClosestPastElement(): StackElement | null {\n\t\tif (this._past.length === 0) {\n\t\t\treturn null;\n\t\t}\n\t\treturn this._past[this._past.length - 1];\n\t}\n\n\tpublic getSecondClosestPastElement(): StackElement | null {\n\t\tif (this._past.length < 2) {\n\t\t\treturn null;\n\t\t}\n\t\treturn this._past[this._past.length - 2];\n\t}\n\n\tpublic getClosestFutureElement(): StackElement | null {\n\t\tif (this._future.length === 0) {\n\t\t\treturn null;\n\t\t}\n\t\treturn this._future[this._future.length - 1];\n\t}\n\n\tpublic hasPastElements(): boolean {\n\t\treturn (this._past.length > 0);\n\t}\n\n\tpublic hasFutureElements(): boolean {\n\t\treturn (this._future.length > 0);\n\t}\n\n\tpublic splitPastWorkspaceElement(toRemove: WorkspaceStackElement, individualMap: Map<string, ResourceStackElement>): void {\n\t\tfor (let j = this._past.length - 1; j >= 0; j--) {\n\t\t\tif (this._past[j] === toRemove) {\n\t\t\t\tif (individualMap.has(this.strResource)) {\n\t\t\t\t\t// gets replaced\n\t\t\t\t\tthis._past[j] = individualMap.get(this.strResource)!;\n\t\t\t\t} else {\n\t\t\t\t\t// gets deleted\n\t\t\t\t\tthis._past.splice(j, 1);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tthis.versionId++;\n\t}\n\n\tpublic splitFutureWorkspaceElement(toRemove: WorkspaceStackElement, individualMap: Map<string, ResourceStackElement>): void {\n\t\tfor (let j = this._future.length - 1; j >= 0; j--) {\n\t\t\tif (this._future[j] === toRemove) {\n\t\t\t\tif (individualMap.has(this.strResource)) {\n\t\t\t\t\t// gets replaced\n\t\t\t\t\tthis._future[j] = individualMap.get(this.strResource)!;\n\t\t\t\t} else {\n\t\t\t\t\t// gets deleted\n\t\t\t\t\tthis._future.splice(j, 1);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tthis.versionId++;\n\t}\n\n\tpublic moveBackward(element: StackElement): void {\n\t\tthis._past.pop();\n\t\tthis._future.push(element);\n\t\tthis.versionId++;\n\t}\n\n\tpublic moveForward(element: StackElement): void {\n\t\tthis._future.pop();\n\t\tthis._past.push(element);\n\t\tthis.versionId++;\n\t}\n}\n\nclass EditStackSnapshot {\n\n\tpublic readonly editStacks: ResourceEditStack[];\n\tprivate readonly _versionIds: number[];\n\n\tconstructor(editStacks: ResourceEditStack[]) {\n\t\tthis.editStacks = editStacks;\n\t\tthis._versionIds = [];\n\t\tfor (let i = 0, len = this.editStacks.length; i < len; i++) {\n\t\t\tthis._versionIds[i] = this.editStacks[i].versionId;\n\t\t}\n\t}\n\n\tpublic isValid(): boolean {\n\t\tfor (let i = 0, len = this.editStacks.length; i < len; i++) {\n\t\t\tif (this._versionIds[i] !== this.editStacks[i].versionId) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t\treturn true;\n\t}\n}\n\nconst missingEditStack = new ResourceEditStack('', '');\nmissingEditStack.locked = true;\n\nexport class UndoRedoService implements IUndoRedoService {\n\tdeclare readonly _serviceBrand: undefined;\n\n\tprivate readonly _editStacks: Map<string, ResourceEditStack>;\n\tprivate readonly _uriComparisonKeyComputers: [string, UriComparisonKeyComputer][];\n\n\tconstructor(\n\t\t@IDialogService private readonly _dialogService: IDialogService,\n\t\t@INotificationService private readonly _notificationService: INotificationService,\n\t) {\n\t\tthis._editStacks = new Map<string, ResourceEditStack>();\n\t\tthis._uriComparisonKeyComputers = [];\n\t}\n\n\tpublic registerUriComparisonKeyComputer(scheme: string, uriComparisonKeyComputer: UriComparisonKeyComputer): IDisposable {\n\t\tthis._uriComparisonKeyComputers.push([scheme, uriComparisonKeyComputer]);\n\t\treturn {\n\t\t\tdispose: () => {\n\t\t\t\tfor (let i = 0, len = this._uriComparisonKeyComputers.length; i < len; i++) {\n\t\t\t\t\tif (this._uriComparisonKeyComputers[i][1] === uriComparisonKeyComputer) {\n\t\t\t\t\t\tthis._uriComparisonKeyComputers.splice(i, 1);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\t}\n\n\tpublic getUriComparisonKey(resource: URI): string {\n\t\tfor (const uriComparisonKeyComputer of this._uriComparisonKeyComputers) {\n\t\t\tif (uriComparisonKeyComputer[0] === resource.scheme) {\n\t\t\t\treturn uriComparisonKeyComputer[1].getComparisonKey(resource);\n\t\t\t}\n\t\t}\n\t\treturn resource.toString();\n\t}\n\n\tprivate _print(label: string): void {\n\t\tconsole.log(`------------------------------------`);\n\t\tconsole.log(`AFTER ${label}: `);\n\t\tconst str: string[] = [];\n\t\tfor (const element of this._editStacks) {\n\t\t\tstr.push(element[1].toString());\n\t\t}\n\t\tconsole.log(str.join('\\n'));\n\t}\n\n\tpublic pushElement(element: IUndoRedoElement, group: UndoRedoGroup = UndoRedoGroup.None, source: UndoRedoSource = UndoRedoSource.None): void {\n\t\tif (element.type === UndoRedoElementType.Resource) {\n\t\t\tconst resourceLabel = getResourceLabel(element.resource);\n\t\t\tconst strResource = this.getUriComparisonKey(element.resource);\n\t\t\tthis._pushElement(new ResourceStackElement(element, resourceLabel, strResource, group.id, group.nextOrder(), source.id, source.nextOrder()));\n\t\t} else {\n\t\t\tconst seen = new Set<string>();\n\t\t\tconst resourceLabels: string[] = [];\n\t\t\tconst strResources: string[] = [];\n\t\t\tfor (const resource of element.resources) {\n\t\t\t\tconst resourceLabel = getResourceLabel(resource);\n\t\t\t\tconst strResource = this.getUriComparisonKey(resource);\n\n\t\t\t\tif (seen.has(strResource)) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tseen.add(strResource);\n\t\t\t\tresourceLabels.push(resourceLabel);\n\t\t\t\tstrResources.push(strResource);\n\t\t\t}\n\n\t\t\tif (resourceLabels.length === 1) {\n\t\t\t\tthis._pushElement(new ResourceStackElement(element, resourceLabels[0], strResources[0], group.id, group.nextOrder(), source.id, source.nextOrder()));\n\t\t\t} else {\n\t\t\t\tthis._pushElement(new WorkspaceStackElement(element, resourceLabels, strResources, group.id, group.nextOrder(), source.id, source.nextOrder()));\n\t\t\t}\n\t\t}\n\t\tif (DEBUG) {\n\t\t\tthis._print('pushElement');\n\t\t}\n\t}\n\n\tprivate _pushElement(element: StackElement): void {\n\t\tfor (let i = 0, len = element.strResources.length; i < len; i++) {\n\t\t\tconst resourceLabel = element.resourceLabels[i];\n\t\t\tconst strResource = element.strResources[i];\n\n\t\t\tlet editStack: ResourceEditStack;\n\t\t\tif (this._editStacks.has(strResource)) {\n\t\t\t\teditStack = this._editStacks.get(strResource)!;\n\t\t\t} else {\n\t\t\t\teditStack = new ResourceEditStack(resourceLabel, strResource);\n\t\t\t\tthis._editStacks.set(strResource, editStack);\n\t\t\t}\n\n\t\t\teditStack.pushElement(element);\n\t\t}\n\t}\n\n\tpublic getLastElement(resource: URI): IUndoRedoElement | null {\n\t\tconst strResource = this.getUriComparisonKey(resource);\n\t\tif (this._editStacks.has(strResource)) {\n\t\t\tconst editStack = this._editStacks.get(strResource)!;\n\t\t\tif (editStack.hasFutureElements()) {\n\t\t\t\treturn null;\n\t\t\t}\n\t\t\tconst closestPastElement = editStack.getClosestPastElement();\n\t\t\treturn closestPastElement ? closestPastElement.actual : null;\n\t\t}\n\t\treturn null;\n\t}\n\n\tprivate _splitPastWorkspaceElement(toRemove: WorkspaceStackElement & { actual: { split(): IResourceUndoRedoElement[] } }, ignoreResources: RemovedResources | null): void {\n\t\tconst individualArr = toRemove.actual.split();\n\t\tconst individualMap = new Map<string, ResourceStackElement>();\n\t\tfor (const _element of individualArr) {\n\t\t\tconst resourceLabel = getResourceLabel(_element.resource);\n\t\t\tconst strResource = this.getUriComparisonKey(_element.resource);\n\t\t\tconst element = new ResourceStackElement(_element, resourceLabel, strResource, 0, 0, 0, 0);\n\t\t\tindividualMap.set(element.strResource, element);\n\t\t}\n\n\t\tfor (const strResource of toRemove.strResources) {\n\t\t\tif (ignoreResources && ignoreResources.has(strResource)) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tconst editStack = this._editStacks.get(strResource)!;\n\t\t\teditStack.splitPastWorkspaceElement(toRemove, individualMap);\n\t\t}\n\t}\n\n\tprivate _splitFutureWorkspaceElement(toRemove: WorkspaceStackElement & { actual: { split(): IResourceUndoRedoElement[] } }, ignoreResources: RemovedResources | null): void {\n\t\tconst individualArr = toRemove.actual.split();\n\t\tconst individualMap = new Map<string, ResourceStackElement>();\n\t\tfor (const _element of individualArr) {\n\t\t\tconst resourceLabel = getResourceLabel(_element.resource);\n\t\t\tconst strResource = this.getUriComparisonKey(_element.resource);\n\t\t\tconst element = new ResourceStackElement(_element, resourceLabel, strResource, 0, 0, 0, 0);\n\t\t\tindividualMap.set(element.strResource, element);\n\t\t}\n\n\t\tfor (const strResource of toRemove.strResources) {\n\t\t\tif (ignoreResources && ignoreResources.has(strResource)) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tconst editStack = this._editStacks.get(strResource)!;\n\t\t\teditStack.splitFutureWorkspaceElement(toRemove, individualMap);\n\t\t}\n\t}\n\n\tpublic removeElements(resource: URI | string): void {\n\t\tconst strResource = typeof resource === 'string' ? resource : this.getUriComparisonKey(resource);\n\t\tif (this._editStacks.has(strResource)) {\n\t\t\tconst editStack = this._editStacks.get(strResource)!;\n\t\t\teditStack.dispose();\n\t\t\tthis._editStacks.delete(strResource);\n\t\t}\n\t\tif (DEBUG) {\n\t\t\tthis._print('removeElements');\n\t\t}\n\t}\n\n\tpublic setElementsValidFlag(resource: URI, isValid: boolean, filter: (element: IUndoRedoElement) => boolean): void {\n\t\tconst strResource = this.getUriComparisonKey(resource);\n\t\tif (this._editStacks.has(strResource)) {\n\t\t\tconst editStack = this._editStacks.get(strResource)!;\n\t\t\teditStack.setElementsValidFlag(isValid, filter);\n\t\t}\n\t\tif (DEBUG) {\n\t\t\tthis._print('setElementsValidFlag');\n\t\t}\n\t}\n\n\tpublic hasElements(resource: URI): boolean {\n\t\tconst strResource = this.getUriComparisonKey(resource);\n\t\tif (this._editStacks.has(strResource)) {\n\t\t\tconst editStack = this._editStacks.get(strResource)!;\n\t\t\treturn (editStack.hasPastElements() || editStack.hasFutureElements());\n\t\t}\n\t\treturn false;\n\t}\n\n\tpublic createSnapshot(resource: URI): ResourceEditStackSnapshot {\n\t\tconst strResource = this.getUriComparisonKey(resource);\n\t\tif (this._editStacks.has(strResource)) {\n\t\t\tconst editStack = this._editStacks.get(strResource)!;\n\t\t\treturn editStack.createSnapshot(resource);\n\t\t}\n\t\treturn new ResourceEditStackSnapshot(resource, []);\n\t}\n\n\tpublic restoreSnapshot(snapshot: ResourceEditStackSnapshot): void {\n\t\tconst strResource = this.getUriComparisonKey(snapshot.resource);\n\t\tif (this._editStacks.has(strResource)) {\n\t\t\tconst editStack = this._editStacks.get(strResource)!;\n\t\t\teditStack.restoreSnapshot(snapshot);\n\n\t\t\tif (!editStack.hasPastElements() && !editStack.hasFutureElements()) {\n\t\t\t\t// the edit stack is now empty, just remove it entirely\n\t\t\t\teditStack.dispose();\n\t\t\t\tthis._editStacks.delete(strResource);\n\t\t\t}\n\t\t}\n\t\tif (DEBUG) {\n\t\t\tthis._print('restoreSnapshot');\n\t\t}\n\t}\n\n\tpublic getElements(resource: URI): IPastFutureElements {\n\t\tconst strResource = this.getUriComparisonKey(resource);\n\t\tif (this._editStacks.has(strResource)) {\n\t\t\tconst editStack = this._editStacks.get(strResource)!;\n\t\t\treturn editStack.getElements();\n\t\t}\n\t\treturn { past: [], future: [] };\n\t}\n\n\tprivate _findClosestUndoElementWithSource(sourceId: number): [StackElement | null, string | null] {\n\t\tif (!sourceId) {\n\t\t\treturn [null, null];\n\t\t}\n\n\t\t// find an element with the sourceId and with the highest sourceOrder ready to be undone\n\t\tlet matchedElement: StackElement | null = null;\n\t\tlet matchedStrResource: string | null = null;\n\n\t\tfor (const [strResource, editStack] of this._editStacks) {\n\t\t\tconst candidate = editStack.getClosestPastElement();\n\t\t\tif (!candidate) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (candidate.sourceId === sourceId) {\n\t\t\t\tif (!matchedElement || candidate.sourceOrder > matchedElement.sourceOrder) {\n\t\t\t\t\tmatchedElement = candidate;\n\t\t\t\t\tmatchedStrResource = strResource;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn [matchedElement, matchedStrResource];\n\t}\n\n\tpublic canUndo(resourceOrSource: URI | UndoRedoSource): boolean {\n\t\tif (resourceOrSource instanceof UndoRedoSource) {\n\t\t\tconst [, matchedStrResource] = this._findClosestUndoElementWithSource(resourceOrSource.id);\n\t\t\treturn matchedStrResource ? true : false;\n\t\t}\n\t\tconst strResource = this.getUriComparisonKey(resourceOrSource);\n\t\tif (this._editStacks.has(strResource)) {\n\t\t\tconst editStack = this._editStacks.get(strResource)!;\n\t\t\treturn editStack.hasPastElements();\n\t\t}\n\t\treturn false;\n\t}\n\n\tprivate _onError(err: Error, element: StackElement): void {\n\t\tonUnexpectedError(err);\n\t\t// An error occurred while undoing or redoing => drop the undo/redo stack for all affected resources\n\t\tfor (const strResource of element.strResources) {\n\t\t\tthis.removeElements(strResource);\n\t\t}\n\t\tthis._notificationService.error(err);\n\t}\n\n\tprivate _acquireLocks(editStackSnapshot: EditStackSnapshot): () => void {\n\t\t// first, check if all locks can be acquired\n\t\tfor (const editStack of editStackSnapshot.editStacks) {\n\t\t\tif (editStack.locked) {\n\t\t\t\tthrow new Error('Cannot acquire edit stack lock');\n\t\t\t}\n\t\t}\n\n\t\t// can acquire all locks\n\t\tfor (const editStack of editStackSnapshot.editStacks) {\n\t\t\teditStack.locked = true;\n\t\t}\n\n\t\treturn () => {\n\t\t\t// release all locks\n\t\t\tfor (const editStack of editStackSnapshot.editStacks) {\n\t\t\t\teditStack.locked = false;\n\t\t\t}\n\t\t};\n\t}\n\n\tprivate _safeInvokeWithLocks(element: StackElement, invoke: () => Promise<void> | void, editStackSnapshot: EditStackSnapshot, cleanup: IDisposable, continuation: () => Promise<void> | void): Promise<void> | void {\n\t\tconst releaseLocks = this._acquireLocks(editStackSnapshot);\n\n\t\tlet result: Promise<void> | void;\n\t\ttry {\n\t\t\tresult = invoke();\n\t\t} catch (err) {\n\t\t\treleaseLocks();\n\t\t\tcleanup.dispose();\n\t\t\treturn this._onError(err, element);\n\t\t}\n\n\t\tif (result) {\n\t\t\t// result is Promise<void>\n\t\t\treturn result.then(\n\t\t\t\t() => {\n\t\t\t\t\treleaseLocks();\n\t\t\t\t\tcleanup.dispose();\n\t\t\t\t\treturn continuation();\n\t\t\t\t},\n\t\t\t\t(err) => {\n\t\t\t\t\treleaseLocks();\n\t\t\t\t\tcleanup.dispose();\n\t\t\t\t\treturn this._onError(err, element);\n\t\t\t\t}\n\t\t\t);\n\t\t} else {\n\t\t\t// result is void\n\t\t\treleaseLocks();\n\t\t\tcleanup.dispose();\n\t\t\treturn continuation();\n\t\t}\n\t}\n\n\tprivate async _invokeWorkspacePrepare(element: WorkspaceStackElement): Promise<IDisposable> {\n\t\tif (typeof element.actual.prepareUndoRedo === 'undefined') {\n\t\t\treturn Disposable.None;\n\t\t}\n\t\tconst result = element.actual.prepareUndoRedo();\n\t\tif (typeof result === 'undefined') {\n\t\t\treturn Disposable.None;\n\t\t}\n\t\treturn result;\n\t}\n\n\tprivate _invokeResourcePrepare(element: ResourceStackElement, callback: (disposable: IDisposable) => Promise<void> | void): void | Promise<void> {\n\t\tif (element.actual.type !== UndoRedoElementType.Workspace || typeof element.actual.prepareUndoRedo === 'undefined') {\n\t\t\t// no preparation needed\n\t\t\treturn callback(Disposable.None);\n\t\t}\n\n\t\tconst r = element.actual.prepareUndoRedo();\n\t\tif (!r) {\n\t\t\t// nothing to clean up\n\t\t\treturn callback(Disposable.None);\n\t\t}\n\n\t\tif (isDisposable(r)) {\n\t\t\treturn callback(r);\n\t\t}\n\n\t\treturn r.then((disposable) => {\n\t\t\treturn callback(disposable);\n\t\t});\n\t}\n\n\tprivate _getAffectedEditStacks(element: WorkspaceStackElement): EditStackSnapshot {\n\t\tconst affectedEditStacks: ResourceEditStack[] = [];\n\t\tfor (const strResource of element.strResources) {\n\t\t\taffectedEditStacks.push(this._editStacks.get(strResource) || missingEditStack);\n\t\t}\n\t\treturn new EditStackSnapshot(affectedEditStacks);\n\t}\n\n\tprivate _tryToSplitAndUndo(strResource: string, element: WorkspaceStackElement, ignoreResources: RemovedResources | null, message: string): WorkspaceVerificationError {\n\t\tif (element.canSplit()) {\n\t\t\tthis._splitPastWorkspaceElement(element, ignoreResources);\n\t\t\tthis._notificationService.warn(message);\n\t\t\treturn new WorkspaceVerificationError(this._undo(strResource, 0, true));\n\t\t} else {\n\t\t\t// Cannot safely split this workspace element => flush all undo/redo stacks\n\t\t\tfor (const strResource of element.strResources) {\n\t\t\t\tthis.removeElements(strResource);\n\t\t\t}\n\t\t\tthis._notificationService.warn(message);\n\t\t\treturn new WorkspaceVerificationError();\n\t\t}\n\t}\n\n\tprivate _checkWorkspaceUndo(strResource: string, element: WorkspaceStackElement, editStackSnapshot: EditStackSnapshot, checkInvalidatedResources: boolean): WorkspaceVerificationError | null {\n\t\tif (element.removedResources) {\n\t\t\treturn this._tryToSplitAndUndo(\n\t\t\t\tstrResource,\n\t\t\t\telement,\n\t\t\t\telement.removedResources,\n\t\t\t\tnls.localize(\n\t\t\t\t\t{ key: 'cannotWorkspaceUndo', comment: ['{0} is a label for an operation. {1} is another message.'] },\n\t\t\t\t\t\"Could not undo '{0}' across all files. {1}\", element.label, element.removedResources.createMessage()\n\t\t\t\t)\n\t\t\t);\n\t\t}\n\t\tif (checkInvalidatedResources && element.invalidatedResources) {\n\t\t\treturn this._tryToSplitAndUndo(\n\t\t\t\tstrResource,\n\t\t\t\telement,\n\t\t\t\telement.invalidatedResources,\n\t\t\t\tnls.localize(\n\t\t\t\t\t{ key: 'cannotWorkspaceUndo', comment: ['{0} is a label for an operation. {1} is another message.'] },\n\t\t\t\t\t\"Could not undo '{0}' across all files. {1}\", element.label, element.invalidatedResources.createMessage()\n\t\t\t\t)\n\t\t\t);\n\t\t}\n\n\t\t// this must be the last past element in all the impacted resources!\n\t\tconst cannotUndoDueToResources: string[] = [];\n\t\tfor (const editStack of editStackSnapshot.editStacks) {\n\t\t\tif (editStack.getClosestPastElement() !== element) {\n\t\t\t\tcannotUndoDueToResources.push(editStack.resourceLabel);\n\t\t\t}\n\t\t}\n\t\tif (cannotUndoDueToResources.length > 0) {\n\t\t\treturn this._tryToSplitAndUndo(\n\t\t\t\tstrResource,\n\t\t\t\telement,\n\t\t\t\tnull,\n\t\t\t\tnls.localize(\n\t\t\t\t\t{ key: 'cannotWorkspaceUndoDueToChanges', comment: ['{0} is a label for an operation. {1} is a list of filenames.'] },\n\t\t\t\t\t\"Could not undo '{0}' across all files because changes were made to {1}\", element.label, cannotUndoDueToResources.join(', ')\n\t\t\t\t)\n\t\t\t);\n\t\t}\n\n\t\tconst cannotLockDueToResources: string[] = [];\n\t\tfor (const editStack of editStackSnapshot.editStacks) {\n\t\t\tif (editStack.locked) {\n\t\t\t\tcannotLockDueToResources.push(editStack.resourceLabel);\n\t\t\t}\n\t\t}\n\t\tif (cannotLockDueToResources.length > 0) {\n\t\t\treturn this._tryToSplitAndUndo(\n\t\t\t\tstrResource,\n\t\t\t\telement,\n\t\t\t\tnull,\n\t\t\t\tnls.localize(\n\t\t\t\t\t{ key: 'cannotWorkspaceUndoDueToInProgressUndoRedo', comment: ['{0} is a label for an operation. {1} is a list of filenames.'] },\n\t\t\t\t\t\"Could not undo '{0}' across all files because there is already an undo or redo operation running on {1}\", element.label, cannotLockDueToResources.join(', ')\n\t\t\t\t)\n\t\t\t);\n\t\t}\n\n\t\t// check if new stack elements were added in the meantime...\n\t\tif (!editStackSnapshot.isValid()) {\n\t\t\treturn this._tryToSplitAndUndo(\n\t\t\t\tstrResource,\n\t\t\t\telement,\n\t\t\t\tnull,\n\t\t\t\tnls.localize(\n\t\t\t\t\t{ key: 'cannotWorkspaceUndoDueToInMeantimeUndoRedo', comment: ['{0} is a label for an operation. {1} is a list of filenames.'] },\n\t\t\t\t\t\"Could not undo '{0}' across all files because an undo or redo operation occurred in the meantime\", element.label\n\t\t\t\t)\n\t\t\t);\n\t\t}\n\n\t\treturn null;\n\t}\n\n\tprivate _workspaceUndo(strResource: string, element: WorkspaceStackElement, undoConfirmed: boolean): Promise<void> | void {\n\t\tconst affectedEditStacks = this._getAffectedEditStacks(element);\n\t\tconst verificationError = this._checkWorkspaceUndo(strResource, element, affectedEditStacks, /*invalidated resources will be checked after the prepare call*/false);\n\t\tif (verificationError) {\n\t\t\treturn verificationError.returnValue;\n\t\t}\n\t\treturn this._confirmAndExecuteWorkspaceUndo(strResource, element, affectedEditStacks, undoConfirmed);\n\t}\n\n\tprivate _isPartOfUndoGroup(element: WorkspaceStackElement): boolean {\n\t\tif (!element.groupId) {\n\t\t\treturn false;\n\t\t}\n\t\t// check that there is at least another element with the same groupId ready to be undone\n\t\tfor (const [, editStack] of this._editStacks) {\n\t\t\tconst pastElement = editStack.getClosestPastElement();\n\t\t\tif (!pastElement) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (pastElement === element) {\n\t\t\t\tconst secondPastElement = editStack.getSecondClosestPastElement();\n\t\t\t\tif (secondPastElement && secondPastElement.groupId === element.groupId) {\n\t\t\t\t\t// there is another element with the same group id in the same stack!\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (pastElement.groupId === element.groupId) {\n\t\t\t\t// there is another element with the same group id in another stack!\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\tprivate async _confirmAndExecuteWorkspaceUndo(strResource: string, element: WorkspaceStackElement, editStackSnapshot: EditStackSnapshot, undoConfirmed: boolean): Promise<void> {\n\n\t\tif (element.canSplit() && !this._isPartOfUndoGroup(element)) {\n\t\t\t// this element can be split\n\n\t\t\tenum UndoChoice {\n\t\t\t\tAll = 0,\n\t\t\t\tThis = 1,\n\t\t\t\tCancel = 2\n\t\t\t}\n\n\t\t\tconst { result } = await this._dialogService.prompt<UndoChoice>({\n\t\t\t\ttype: Severity.Info,\n\t\t\t\tmessage: nls.localize('confirmWorkspace', \"Would you like to undo '{0}' across all files?\", element.label),\n\t\t\t\tbuttons: [\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: nls.localize({ key: 'ok', comment: ['{0} denotes a number that is > 1, && denotes a mnemonic'] }, \"&&Undo in {0} Files\", editStackSnapshot.editStacks.length),\n\t\t\t\t\t\trun: () => UndoChoice.All\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: nls.localize({ key: 'nok', comment: ['&& denotes a mnemonic'] }, \"Undo this &&File\"),\n\t\t\t\t\t\trun: () => UndoChoice.This\n\t\t\t\t\t}\n\t\t\t\t],\n\t\t\t\tcancelButton: {\n\t\t\t\t\trun: () => UndoChoice.Cancel\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tif (result === UndoChoice.Cancel) {\n\t\t\t\t// choice: cancel\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (result === UndoChoice.This) {\n\t\t\t\t// choice: undo this file\n\t\t\t\tthis._splitPastWorkspaceElement(element, null);\n\t\t\t\treturn this._undo(strResource, 0, true);\n\t\t\t}\n\n\t\t\t// choice: undo in all files\n\n\t\t\t// At this point, it is possible that the element has been made invalid in the meantime (due to the confirmation await)\n\t\t\tconst verificationError1 = this._checkWorkspaceUndo(strResource, element, editStackSnapshot, /*invalidated resources will be checked after the prepare call*/false);\n\t\t\tif (verificationError1) {\n\t\t\t\treturn verificationError1.returnValue;\n\t\t\t}\n\n\t\t\tundoConfirmed = true;\n\t\t}\n\n\t\t// prepare\n\t\tlet cleanup: IDisposable;\n\t\ttry {\n\t\t\tcleanup = await this._invokeWorkspacePrepare(element);\n\t\t} catch (err) {\n\t\t\treturn this._onError(err, element);\n\t\t}\n\n\t\t// At this point, it is possible that the element has been made invalid in the meantime (due to the prepare await)\n\t\tconst verificationError2 = this._checkWorkspaceUndo(strResource, element, editStackSnapshot, /*now also check that there are no more invalidated resources*/true);\n\t\tif (verificationError2) {\n\t\t\tcleanup.dispose();\n\t\t\treturn verificationError2.returnValue;\n\t\t}\n\n\t\tfor (const editStack of editStackSnapshot.editStacks) {\n\t\t\teditStack.moveBackward(element);\n\t\t}\n\t\treturn this._safeInvokeWithLocks(element, () => element.actual.undo(), editStackSnapshot, cleanup, () => this._continueUndoInGroup(element.groupId, undoConfirmed));\n\t}\n\n\tprivate _resourceUndo(editStack: ResourceEditStack, element: ResourceStackElement, undoConfirmed: boolean): Promise<void> | void {\n\t\tif (!element.isValid) {\n\t\t\t// invalid element => immediately flush edit stack!\n\t\t\teditStack.flushAllElements();\n\t\t\treturn;\n\t\t}\n\t\tif (editStack.locked) {\n\t\t\tconst message = nls.localize(\n\t\t\t\t{ key: 'cannotResourceUndoDueToInProgressUndoRedo', comment: ['{0} is a label for an operation.'] },\n\t\t\t\t\"Could not undo '{0}' because there is already an undo or redo operation running.\", element.label\n\t\t\t);\n\t\t\tthis._notificationService.warn(message);\n\t\t\treturn;\n\t\t}\n\t\treturn this._invokeResourcePrepare(element, (cleanup) => {\n\t\t\teditStack.moveBackward(element);\n\t\t\treturn this._safeInvokeWithLocks(element, () => element.actual.undo(), new EditStackSnapshot([editStack]), cleanup, () => this._continueUndoInGroup(element.groupId, undoConfirmed));\n\t\t});\n\t}\n\n\tprivate _findClosestUndoElementInGroup(groupId: number): [StackElement | null, string | null] {\n\t\tif (!groupId) {\n\t\t\treturn [null, null];\n\t\t}\n\n\t\t// find another element with the same groupId and with the highest groupOrder ready to be undone\n\t\tlet matchedElement: StackElement | null = null;\n\t\tlet matchedStrResource: string | null = null;\n\n\t\tfor (const [strResource, editStack] of this._editStacks) {\n\t\t\tconst candidate = editStack.getClosestPastElement();\n\t\t\tif (!candidate) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (candidate.groupId === groupId) {\n\t\t\t\tif (!matchedElement || candidate.groupOrder > matchedElement.groupOrder) {\n\t\t\t\t\tmatchedElement = candidate;\n\t\t\t\t\tmatchedStrResource = strResource;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn [matchedElement, matchedStrResource];\n\t}\n\n\tprivate _continueUndoInGroup(groupId: number, undoConfirmed: boolean): Promise<void> | void {\n\t\tif (!groupId) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst [, matchedStrResource] = this._findClosestUndoElementInGroup(groupId);\n\t\tif (matchedStrResource) {\n\t\t\treturn this._undo(matchedStrResource, 0, undoConfirmed);\n\t\t}\n\t}\n\n\tpublic undo(resourceOrSource: URI | UndoRedoSource): Promise<void> | void {\n\t\tif (resourceOrSource instanceof UndoRedoSource) {\n\t\t\tconst [, matchedStrResource] = this._findClosestUndoElementWithSource(resourceOrSource.id);\n\t\t\treturn matchedStrResource ? this._undo(matchedStrResource, resourceOrSource.id, false) : undefined;\n\t\t}\n\t\tif (typeof resourceOrSource === 'string') {\n\t\t\treturn this._undo(resourceOrSource, 0, false);\n\t\t}\n\t\treturn this._undo(this.getUriComparisonKey(resourceOrSource), 0, false);\n\t}\n\n\tprivate _undo(strResource: string, sourceId: number = 0, undoConfirmed: boolean): Promise<void> | void {\n\t\tif (!this._editStacks.has(strResource)) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst editStack = this._editStacks.get(strResource)!;\n\t\tconst element = editStack.getClosestPastElement();\n\t\tif (!element) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (element.groupId) {\n\t\t\t// this element is a part of a group, we need to make sure undoing in a group is in order\n\t\t\tconst [matchedElement, matchedStrResource] = this._findClosestUndoElementInGroup(element.groupId);\n\t\t\tif (element !== matchedElement && matchedStrResource) {\n\t\t\t\t// there is an element in the same group that should be undone before this one\n\t\t\t\treturn this._undo(matchedStrResource, sourceId, undoConfirmed);\n\t\t\t}\n\t\t}\n\n\t\tconst shouldPromptForConfirmation = (element.sourceId !== sourceId || element.confirmBeforeUndo);\n\t\tif (shouldPromptForConfirmation && !undoConfirmed) {\n\t\t\t// Hit a different source or the element asks for prompt before undo, prompt for confirmation\n\t\t\treturn this._confirmAndContinueUndo(strResource, sourceId, element);\n\t\t}\n\n\t\ttry {\n\t\t\tif (element.type === UndoRedoElementType.Workspace) {\n\t\t\t\treturn this._workspaceUndo(strResource, element, undoConfirmed);\n\t\t\t} else {\n\t\t\t\treturn this._resourceUndo(editStack, element, undoConfirmed);\n\t\t\t}\n\t\t} finally {\n\t\t\tif (DEBUG) {\n\t\t\t\tthis._print('undo');\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate async _confirmAndContinueUndo(strResource: string, sourceId: number, element: StackElement): Promise<void> {\n\t\tconst result = await this._dialogService.confirm({\n\t\t\tmessage: nls.localize('confirmDifferentSource', \"Would you like to undo '{0}'?\", element.label),\n\t\t\tprimaryButton: nls.localize({ key: 'confirmDifferentSource.yes', comment: ['&& denotes a mnemonic'] }, \"&&Yes\"),\n\t\t\tcancelButton: nls.localize('confirmDifferentSource.no', \"No\")\n\t\t});\n\n\t\tif (!result.confirmed) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn this._undo(strResource, sourceId, true);\n\t}\n\n\tprivate _findClosestRedoElementWithSource(sourceId: number): [StackElement | null, string | null] {\n\t\tif (!sourceId) {\n\t\t\treturn [null, null];\n\t\t}\n\n\t\t// find an element with sourceId and with the lowest sourceOrder ready to be redone\n\t\tlet matchedElement: StackElement | null = null;\n\t\tlet matchedStrResource: string | null = null;\n\n\t\tfor (const [strResource, editStack] of this._editStacks) {\n\t\t\tconst candidate = editStack.getClosestFutureElement();\n\t\t\tif (!candidate) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (candidate.sourceId === sourceId) {\n\t\t\t\tif (!matchedElement || candidate.sourceOrder < matchedElement.sourceOrder) {\n\t\t\t\t\tmatchedElement = candidate;\n\t\t\t\t\tmatchedStrResource = strResource;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn [matchedElement, matchedStrResource];\n\t}\n\n\tpublic canRedo(resourceOrSource: URI | UndoRedoSource): boolean {\n\t\tif (resourceOrSource instanceof UndoRedoSource) {\n\t\t\tconst [, matchedStrResource] = this._findClosestRedoElementWithSource(resourceOrSource.id);\n\t\t\treturn matchedStrResource ? true : false;\n\t\t}\n\t\tconst strResource = this.getUriComparisonKey(resourceOrSource);\n\t\tif (this._editStacks.has(strResource)) {\n\t\t\tconst editStack = this._editStacks.get(strResource)!;\n\t\t\treturn editStack.hasFutureElements();\n\t\t}\n\t\treturn false;\n\t}\n\n\tprivate _tryToSplitAndRedo(strResource: string, element: WorkspaceStackElement, ignoreResources: RemovedResources | null, message: string): WorkspaceVerificationError {\n\t\tif (element.canSplit()) {\n\t\t\tthis._splitFutureWorkspaceElement(element, ignoreResources);\n\t\t\tthis._notificationService.warn(message);\n\t\t\treturn new WorkspaceVerificationError(this._redo(strResource));\n\t\t} else {\n\t\t\t// Cannot safely split this workspace element => flush all undo/redo stacks\n\t\t\tfor (const strResource of element.strResources) {\n\t\t\t\tthis.removeElements(strResource);\n\t\t\t}\n\t\t\tthis._notificationService.warn(message);\n\t\t\treturn new WorkspaceVerificationError();\n\t\t}\n\t}\n\n\tprivate _checkWorkspaceRedo(strResource: string, element: WorkspaceStackElement, editStackSnapshot: EditStackSnapshot, checkInvalidatedResources: boolean): WorkspaceVerificationError | null {\n\t\tif (element.removedResources) {\n\t\t\treturn this._tryToSplitAndRedo(\n\t\t\t\tstrResource,\n\t\t\t\telement,\n\t\t\t\telement.removedResources,\n\t\t\t\tnls.localize(\n\t\t\t\t\t{ key: 'cannotWorkspaceRedo', comment: ['{0} is a label for an operation. {1} is another message.'] },\n\t\t\t\t\t\"Could not redo '{0}' across all files. {1}\", element.label, element.removedResources.createMessage()\n\t\t\t\t)\n\t\t\t);\n\t\t}\n\t\tif (checkInvalidatedResources && element.invalidatedResources) {\n\t\t\treturn this._tryToSplitAndRedo(\n\t\t\t\tstrResource,\n\t\t\t\telement,\n\t\t\t\telement.invalidatedResources,\n\t\t\t\tnls.localize(\n\t\t\t\t\t{ key: 'cannotWorkspaceRedo', comment: ['{0} is a label for an operation. {1} is another message.'] },\n\t\t\t\t\t\"Could not redo '{0}' across all files. {1}\", element.label, element.invalidatedResources.createMessage()\n\t\t\t\t)\n\t\t\t);\n\t\t}\n\n\t\t// this must be the last future element in all the impacted resources!\n\t\tconst cannotRedoDueToResources: string[] = [];\n\t\tfor (const editStack of editStackSnapshot.editStacks) {\n\t\t\tif (editStack.getClosestFutureElement() !== element) {\n\t\t\t\tcannotRedoDueToResources.push(editStack.resourceLabel);\n\t\t\t}\n\t\t}\n\t\tif (cannotRedoDueToResources.length > 0) {\n\t\t\treturn this._tryToSplitAndRedo(\n\t\t\t\tstrResource,\n\t\t\t\telement,\n\t\t\t\tnull,\n\t\t\t\tnls.localize(\n\t\t\t\t\t{ key: 'cannotWorkspaceRedoDueToChanges', comment: ['{0} is a label for an operation. {1} is a list of filenames.'] },\n\t\t\t\t\t\"Could not redo '{0}' across all files because changes were made to {1}\", element.label, cannotRedoDueToResources.join(', ')\n\t\t\t\t)\n\t\t\t);\n\t\t}\n\n\t\tconst cannotLockDueToResources: string[] = [];\n\t\tfor (const editStack of editStackSnapshot.editStacks) {\n\t\t\tif (editStack.locked) {\n\t\t\t\tcannotLockDueToResources.push(editStack.resourceLabel);\n\t\t\t}\n\t\t}\n\t\tif (cannotLockDueToResources.length > 0) {\n\t\t\treturn this._tryToSplitAndRedo(\n\t\t\t\tstrResource,\n\t\t\t\telement,\n\t\t\t\tnull,\n\t\t\t\tnls.localize(\n\t\t\t\t\t{ key: 'cannotWorkspaceRedoDueToInProgressUndoRedo', comment: ['{0} is a label for an operation. {1} is a list of filenames.'] },\n\t\t\t\t\t\"Could not redo '{0}' across all files because there is already an undo or redo operation running on {1}\", element.label, cannotLockDueToResources.join(', ')\n\t\t\t\t)\n\t\t\t);\n\t\t}\n\n\t\t// check if new stack elements were added in the meantime...\n\t\tif (!editStackSnapshot.isValid()) {\n\t\t\treturn this._tryToSplitAndRedo(\n\t\t\t\tstrResource,\n\t\t\t\telement,\n\t\t\t\tnull,\n\t\t\t\tnls.localize(\n\t\t\t\t\t{ key: 'cannotWorkspaceRedoDueToInMeantimeUndoRedo', comment: ['{0} is a label for an operation. {1} is a list of filenames.'] },\n\t\t\t\t\t\"Could not redo '{0}' across all files because an undo or redo operation occurred in the meantime\", element.label\n\t\t\t\t)\n\t\t\t);\n\t\t}\n\n\t\treturn null;\n\t}\n\n\tprivate _workspaceRedo(strResource: string, element: WorkspaceStackElement): Promise<void> | void {\n\t\tconst affectedEditStacks = this._getAffectedEditStacks(element);\n\t\tconst verificationError = this._checkWorkspaceRedo(strResource, element, affectedEditStacks, /*invalidated resources will be checked after the prepare call*/false);\n\t\tif (verificationError) {\n\t\t\treturn verificationError.returnValue;\n\t\t}\n\t\treturn this._executeWorkspaceRedo(strResource, element, affectedEditStacks);\n\t}\n\n\tprivate async _executeWorkspaceRedo(strResource: string, element: WorkspaceStackElement, editStackSnapshot: EditStackSnapshot): Promise<void> {\n\t\t// prepare\n\t\tlet cleanup: IDisposable;\n\t\ttry {\n\t\t\tcleanup = await this._invokeWorkspacePrepare(element);\n\t\t} catch (err) {\n\t\t\treturn this._onError(err, element);\n\t\t}\n\n\t\t// At this point, it is possible that the element has been made invalid in the meantime (due to the prepare await)\n\t\tconst verificationError = this._checkWorkspaceRedo(strResource, element, editStackSnapshot, /*now also check that there are no more invalidated resources*/true);\n\t\tif (verificationError) {\n\t\t\tcleanup.dispose();\n\t\t\treturn verificationError.returnValue;\n\t\t}\n\n\t\tfor (const editStack of editStackSnapshot.editStacks) {\n\t\t\teditStack.moveForward(element);\n\t\t}\n\t\treturn this._safeInvokeWithLocks(element, () => element.actual.redo(), editStackSnapshot, cleanup, () => this._continueRedoInGroup(element.groupId));\n\t}\n\n\tprivate _resourceRedo(editStack: ResourceEditStack, element: ResourceStackElement): Promise<void> | void {\n\t\tif (!element.isValid) {\n\t\t\t// invalid element => immediately flush edit stack!\n\t\t\teditStack.flushAllElements();\n\t\t\treturn;\n\t\t}\n\t\tif (editStack.locked) {\n\t\t\tconst message = nls.localize(\n\t\t\t\t{ key: 'cannotResourceRedoDueToInProgressUndoRedo', comment: ['{0} is a label for an operation.'] },\n\t\t\t\t\"Could not redo '{0}' because there is already an undo or redo operation running.\", element.label\n\t\t\t);\n\t\t\tthis._notificationService.warn(message);\n\t\t\treturn;\n\t\t}\n\n\t\treturn this._invokeResourcePrepare(element, (cleanup) => {\n\t\t\teditStack.moveForward(element);\n\t\t\treturn this._safeInvokeWithLocks(element, () => element.actual.redo(), new EditStackSnapshot([editStack]), cleanup, () => this._continueRedoInGroup(element.groupId));\n\t\t});\n\t}\n\n\tprivate _findClosestRedoElementInGroup(groupId: number): [StackElement | null, string | null] {\n\t\tif (!groupId) {\n\t\t\treturn [null, null];\n\t\t}\n\n\t\t// find another element with the same groupId and with the lowest groupOrder ready to be redone\n\t\tlet matchedElement: StackElement | null = null;\n\t\tlet matchedStrResource: string | null = null;\n\n\t\tfor (const [strResource, editStack] of this._editStacks) {\n\t\t\tconst candidate = editStack.getClosestFutureElement();\n\t\t\tif (!candidate) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (candidate.groupId === groupId) {\n\t\t\t\tif (!matchedElement || candidate.groupOrder < matchedElement.groupOrder) {\n\t\t\t\t\tmatchedElement = candidate;\n\t\t\t\t\tmatchedStrResource = strResource;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn [matchedElement, matchedStrResource];\n\t}\n\n\tprivate _continueRedoInGroup(groupId: number): Promise<void> | void {\n\t\tif (!groupId) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst [, matchedStrResource] = this._findClosestRedoElementInGroup(groupId);\n\t\tif (matchedStrResource) {\n\t\t\treturn this._redo(matchedStrResource);\n\t\t}\n\t}\n\n\tpublic redo(resourceOrSource: URI | UndoRedoSource | string): Promise<void> | void {\n\t\tif (resourceOrSource instanceof UndoRedoSource) {\n\t\t\tconst [, matchedStrResource] = this._findClosestRedoElementWithSource(resourceOrSource.id);\n\t\t\treturn matchedStrResource ? this._redo(matchedStrResource) : undefined;\n\t\t}\n\t\tif (typeof resourceOrSource === 'string') {\n\t\t\treturn this._redo(resourceOrSource);\n\t\t}\n\t\treturn this._redo(this.getUriComparisonKey(resourceOrSource));\n\t}\n\n\tprivate _redo(strResource: string): Promise<void> | void {\n\t\tif (!this._editStacks.has(strResource)) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst editStack = this._editStacks.get(strResource)!;\n\t\tconst element = editStack.getClosestFutureElement();\n\t\tif (!element) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (element.groupId) {\n\t\t\t// this element is a part of a group, we need to make sure redoing in a group is in order\n\t\t\tconst [matchedElement, matchedStrResource] = this._findClosestRedoElementInGroup(element.groupId);\n\t\t\tif (element !== matchedElement && matchedStrResource) {\n\t\t\t\t// there is an element in the same group that should be redone before this one\n\t\t\t\treturn this._redo(matchedStrResource);\n\t\t\t}\n\t\t}\n\n\t\ttry {\n\t\t\tif (element.type === UndoRedoElementType.Workspace) {\n\t\t\t\treturn this._workspaceRedo(strResource, element);\n\t\t\t} else {\n\t\t\t\treturn this._resourceRedo(editStack, element);\n\t\t\t}\n\t\t} finally {\n\t\t\tif (DEBUG) {\n\t\t\t\tthis._print('redo');\n\t\t\t}\n\t\t}\n\t}\n}\n\nclass WorkspaceVerificationError {\n\tconstructor(public readonly returnValue: Promise<void> | void) { }\n}\n\nregisterSingleton(IUndoRedoService, UndoRedoService, InstantiationType.Delayed);\n"]}