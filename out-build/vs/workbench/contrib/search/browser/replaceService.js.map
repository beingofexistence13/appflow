{"version":3,"sources":["vs/workbench/contrib/search/browser/replaceService.ts"],"names":[],"mappings":"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","file":"replaceService.js","sourceRoot":"file:///workspace/appflow/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as nls from 'vs/nls';\nimport { URI } from 'vs/base/common/uri';\nimport * as network from 'vs/base/common/network';\nimport { Disposable, IReference } from 'vs/base/common/lifecycle';\nimport { IReplaceService } from 'vs/workbench/contrib/search/browser/replace';\nimport { IEditorService } from 'vs/workbench/services/editor/common/editorService';\nimport { IModelService } from 'vs/editor/common/services/model';\nimport { ILanguageService } from 'vs/editor/common/languages/language';\nimport { Match, FileMatch, FileMatchOrMatch, ISearchViewModelWorkbenchService, MatchInNotebook } from 'vs/workbench/contrib/search/browser/searchModel';\nimport { IProgress, IProgressStep } from 'vs/platform/progress/common/progress';\nimport { ITextModelService, ITextModelContentProvider } from 'vs/editor/common/services/resolverService';\nimport { IWorkbenchContribution } from 'vs/workbench/common/contributions';\nimport { ScrollType } from 'vs/editor/common/editorCommon';\nimport { ITextModel } from 'vs/editor/common/model';\nimport { IInstantiationService } from 'vs/platform/instantiation/common/instantiation';\nimport { createTextBufferFactoryFromSnapshot } from 'vs/editor/common/model/textModel';\nimport { ITextFileService } from 'vs/workbench/services/textfile/common/textfiles';\nimport { IBulkEditService, ResourceTextEdit } from 'vs/editor/browser/services/bulkEditService';\nimport { Range } from 'vs/editor/common/core/range';\nimport { EditOperation, ISingleEditOperation } from 'vs/editor/common/core/editOperation';\nimport { ILabelService } from 'vs/platform/label/common/label';\nimport { dirname } from 'vs/base/common/resources';\nimport { Promises } from 'vs/base/common/async';\nimport { SaveSourceRegistry } from 'vs/workbench/common/editor';\nimport { CellUri, IResolvedNotebookEditorModel } from 'vs/workbench/contrib/notebook/common/notebookCommon';\nimport { INotebookEditorModelResolverService } from 'vs/workbench/contrib/notebook/common/notebookEditorModelResolverService';\n\nconst REPLACE_PREVIEW = 'replacePreview';\n\nconst toReplaceResource = (fileResource: URI): URI => {\n\treturn fileResource.with({ scheme: network.Schemas.internal, fragment: REPLACE_PREVIEW, query: JSON.stringify({ scheme: fileResource.scheme }) });\n};\n\nconst toFileResource = (replaceResource: URI): URI => {\n\treturn replaceResource.with({ scheme: JSON.parse(replaceResource.query)['scheme'], fragment: '', query: '' });\n};\n\nexport class ReplacePreviewContentProvider implements ITextModelContentProvider, IWorkbenchContribution {\n\n\tconstructor(\n\t\t@IInstantiationService private readonly instantiationService: IInstantiationService,\n\t\t@ITextModelService private readonly textModelResolverService: ITextModelService\n\t) {\n\t\tthis.textModelResolverService.registerTextModelContentProvider(network.Schemas.internal, this);\n\t}\n\n\tprovideTextContent(uri: URI): Promise<ITextModel> | null {\n\t\tif (uri.fragment === REPLACE_PREVIEW) {\n\t\t\treturn this.instantiationService.createInstance(ReplacePreviewModel).resolve(uri);\n\t\t}\n\t\treturn null;\n\t}\n}\n\nclass ReplacePreviewModel extends Disposable {\n\tconstructor(\n\t\t@IModelService private readonly modelService: IModelService,\n\t\t@ILanguageService private readonly languageService: ILanguageService,\n\t\t@ITextModelService private readonly textModelResolverService: ITextModelService,\n\t\t@IReplaceService private readonly replaceService: IReplaceService,\n\t\t@ISearchViewModelWorkbenchService private readonly searchWorkbenchService: ISearchViewModelWorkbenchService\n\t) {\n\t\tsuper();\n\t}\n\n\tasync resolve(replacePreviewUri: URI): Promise<ITextModel> {\n\t\tconst fileResource = toFileResource(replacePreviewUri);\n\t\tconst fileMatch = <FileMatch>this.searchWorkbenchService.searchModel.searchResult.matches().filter(match => match.resource.toString() === fileResource.toString())[0];\n\t\tconst ref = this._register(await this.textModelResolverService.createModelReference(fileResource));\n\t\tconst sourceModel = ref.object.textEditorModel;\n\t\tconst sourceModelLanguageId = sourceModel.getLanguageId();\n\t\tconst replacePreviewModel = this.modelService.createModel(createTextBufferFactoryFromSnapshot(sourceModel.createSnapshot()), this.languageService.createById(sourceModelLanguageId), replacePreviewUri);\n\t\tthis._register(fileMatch.onChange(({ forceUpdateModel }) => this.update(sourceModel, replacePreviewModel, fileMatch, forceUpdateModel)));\n\t\tthis._register(this.searchWorkbenchService.searchModel.onReplaceTermChanged(() => this.update(sourceModel, replacePreviewModel, fileMatch)));\n\t\tthis._register(fileMatch.onDispose(() => replacePreviewModel.dispose())); // TODO@Sandeep we should not dispose a model directly but rather the reference (depends on https://github.com/microsoft/vscode/issues/17073)\n\t\tthis._register(replacePreviewModel.onWillDispose(() => this.dispose()));\n\t\tthis._register(sourceModel.onWillDispose(() => this.dispose()));\n\t\treturn replacePreviewModel;\n\t}\n\n\tprivate update(sourceModel: ITextModel, replacePreviewModel: ITextModel, fileMatch: FileMatch, override: boolean = false): void {\n\t\tif (!sourceModel.isDisposed() && !replacePreviewModel.isDisposed()) {\n\t\t\tthis.replaceService.updateReplacePreview(fileMatch, override);\n\t\t}\n\t}\n}\n\nexport class ReplaceService implements IReplaceService {\n\n\tdeclare readonly _serviceBrand: undefined;\n\n\tprivate static readonly REPLACE_SAVE_SOURCE = SaveSourceRegistry.registerSource('searchReplace.source', nls.localize('searchReplace.source', \"Search and Replace\"));\n\n\tconstructor(\n\t\t@ITextFileService private readonly textFileService: ITextFileService,\n\t\t@IEditorService private readonly editorService: IEditorService,\n\t\t@ITextModelService private readonly textModelResolverService: ITextModelService,\n\t\t@IBulkEditService private readonly bulkEditorService: IBulkEditService,\n\t\t@ILabelService private readonly labelService: ILabelService,\n\t\t@INotebookEditorModelResolverService private readonly notebookEditorModelResolverService: INotebookEditorModelResolverService\n\t) { }\n\n\treplace(match: Match): Promise<any>;\n\treplace(files: FileMatch[], progress?: IProgress<IProgressStep>): Promise<any>;\n\treplace(match: FileMatchOrMatch, progress?: IProgress<IProgressStep>, resource?: URI): Promise<any>;\n\tasync replace(arg: any, progress: IProgress<IProgressStep> | undefined = undefined, resource: URI | null = null): Promise<any> {\n\t\tconst edits = this.createEdits(arg, resource);\n\t\tawait this.bulkEditorService.apply(edits, { progress });\n\n\t\tconst rawTextPromises = edits.map(async e => {\n\t\t\tif (e.resource.scheme === network.Schemas.vscodeNotebookCell) {\n\t\t\t\tconst notebookResource = CellUri.parse(e.resource)?.notebook;\n\t\t\t\tif (notebookResource) {\n\t\t\t\t\tlet ref: IReference<IResolvedNotebookEditorModel> | undefined;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tref = await this.notebookEditorModelResolverService.resolve(notebookResource);\n\t\t\t\t\t\tawait ref.object.save({ source: ReplaceService.REPLACE_SAVE_SOURCE });\n\t\t\t\t\t} finally {\n\t\t\t\t\t\tref?.dispose();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn;\n\t\t\t} else {\n\t\t\t\treturn this.textFileService.files.get(e.resource)?.save({ source: ReplaceService.REPLACE_SAVE_SOURCE });\n\t\t\t}\n\t\t});\n\n\t\treturn Promises.settled(rawTextPromises);\n\t}\n\n\tasync openReplacePreview(element: FileMatchOrMatch, preserveFocus?: boolean, sideBySide?: boolean, pinned?: boolean): Promise<any> {\n\t\tconst fileMatch = element instanceof Match ? element.parent() : element;\n\n\t\tconst editor = await this.editorService.openEditor({\n\t\t\toriginal: { resource: fileMatch.resource },\n\t\t\tmodified: { resource: toReplaceResource(fileMatch.resource) },\n\t\t\tlabel: nls.localize('fileReplaceChanges', \"{0} â†” {1} (Replace Preview)\", fileMatch.name(), fileMatch.name()),\n\t\t\tdescription: this.labelService.getUriLabel(dirname(fileMatch.resource), { relative: true }),\n\t\t\toptions: {\n\t\t\t\tpreserveFocus,\n\t\t\t\tpinned,\n\t\t\t\trevealIfVisible: true\n\t\t\t}\n\t\t});\n\t\tconst input = editor?.input;\n\t\tconst disposable = fileMatch.onDispose(() => {\n\t\t\tinput?.dispose();\n\t\t\tdisposable.dispose();\n\t\t});\n\t\tawait this.updateReplacePreview(fileMatch);\n\t\tif (editor) {\n\t\t\tconst editorControl = editor.getControl();\n\t\t\tif (element instanceof Match && editorControl) {\n\t\t\t\teditorControl.revealLineInCenter(element.range().startLineNumber, ScrollType.Immediate);\n\t\t\t}\n\t\t}\n\t}\n\n\tasync updateReplacePreview(fileMatch: FileMatch, override: boolean = false): Promise<void> {\n\t\tconst replacePreviewUri = toReplaceResource(fileMatch.resource);\n\t\tconst [sourceModelRef, replaceModelRef] = await Promise.all([this.textModelResolverService.createModelReference(fileMatch.resource), this.textModelResolverService.createModelReference(replacePreviewUri)]);\n\t\tconst sourceModel = sourceModelRef.object.textEditorModel;\n\t\tconst replaceModel = replaceModelRef.object.textEditorModel;\n\t\t// If model is disposed do not update\n\t\ttry {\n\t\t\tif (sourceModel && replaceModel) {\n\t\t\t\tif (override) {\n\t\t\t\t\treplaceModel.setValue(sourceModel.getValue());\n\t\t\t\t} else {\n\t\t\t\t\treplaceModel.undo();\n\t\t\t\t}\n\t\t\t\tthis.applyEditsToPreview(fileMatch, replaceModel);\n\t\t\t}\n\t\t} finally {\n\t\t\tsourceModelRef.dispose();\n\t\t\treplaceModelRef.dispose();\n\t\t}\n\t}\n\n\tprivate applyEditsToPreview(fileMatch: FileMatch, replaceModel: ITextModel): void {\n\t\tconst resourceEdits = this.createEdits(fileMatch, replaceModel.uri);\n\t\tconst modelEdits: ISingleEditOperation[] = [];\n\t\tfor (const resourceEdit of resourceEdits) {\n\t\t\tmodelEdits.push(EditOperation.replaceMove(\n\t\t\t\tRange.lift(resourceEdit.textEdit.range),\n\t\t\t\tresourceEdit.textEdit.text)\n\t\t\t);\n\t\t}\n\t\treplaceModel.pushEditOperations([], modelEdits.sort((a, b) => Range.compareRangesUsingStarts(a.range, b.range)), () => []);\n\t}\n\n\tprivate createEdits(arg: FileMatchOrMatch | FileMatch[], resource: URI | null = null): ResourceTextEdit[] {\n\t\tconst edits: ResourceTextEdit[] = [];\n\n\t\tif (arg instanceof Match) {\n\t\t\tif (arg instanceof MatchInNotebook) {\n\t\t\t\tif (!arg.isWebviewMatch()) {\n\t\t\t\t\t// only apply edits if it's not a webview match, since webview matches are read-only\n\t\t\t\t\tconst match = <MatchInNotebook>arg;\n\t\t\t\t\tedits.push(this.createEdit(match, match.replaceString, match.cell.uri));\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tconst match = <Match>arg;\n\t\t\t\tedits.push(this.createEdit(match, match.replaceString, resource));\n\t\t\t}\n\t\t}\n\n\t\tif (arg instanceof FileMatch) {\n\t\t\targ = [arg];\n\t\t}\n\n\t\tif (arg instanceof Array) {\n\t\t\targ.forEach(element => {\n\t\t\t\tconst fileMatch = <FileMatch>element;\n\t\t\t\tif (fileMatch.count() > 0) {\n\t\t\t\t\tedits.push(...fileMatch.matches().flatMap(\n\t\t\t\t\t\tmatch => this.createEdits(match, resource)\n\t\t\t\t\t));\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\treturn edits;\n\t}\n\n\tprivate createEdit(match: Match, text: string, resource: URI | null = null): ResourceTextEdit {\n\t\tconst fileMatch: FileMatch = match.parent();\n\t\treturn new ResourceTextEdit(\n\t\t\tresource ?? fileMatch.resource,\n\t\t\t{ range: match.range(), text }, undefined, undefined\n\t\t);\n\t}\n}\n"]}