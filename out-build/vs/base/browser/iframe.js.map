{"version":3,"sources":["file:///workspace/appflow/src/vs/base/browser/iframe.ts"],"names":[],"mappings":"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","file":"iframe.js","sourceRoot":"file:///workspace/appflow/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\n/**\n * Represents a window in a possible chain of iframes\n */\nexport interface IWindowChainElement {\n\t/**\n\t * The window object for it\n\t */\n\twindow: Window;\n\t/**\n\t * The iframe element inside the window.parent corresponding to window\n\t */\n\tiframeElement: Element | null;\n}\n\nlet hasDifferentOriginAncestorFlag: boolean = false;\nlet sameOriginWindowChainCache: IWindowChainElement[] | null = null;\n\nfunction getParentWindowIfSameOrigin(w: Window): Window | null {\n\tif (!w.parent || w.parent === w) {\n\t\treturn null;\n\t}\n\n\t// Cannot really tell if we have access to the parent window unless we try to access something in it\n\ttry {\n\t\tconst location = w.location;\n\t\tconst parentLocation = w.parent.location;\n\t\tif (location.origin !== 'null' && parentLocation.origin !== 'null' && location.origin !== parentLocation.origin) {\n\t\t\thasDifferentOriginAncestorFlag = true;\n\t\t\treturn null;\n\t\t}\n\t} catch (e) {\n\t\thasDifferentOriginAncestorFlag = true;\n\t\treturn null;\n\t}\n\n\treturn w.parent;\n}\n\nexport class IframeUtils {\n\n\t/**\n\t * Returns a chain of embedded windows with the same origin (which can be accessed programmatically).\n\t * Having a chain of length 1 might mean that the current execution environment is running outside of an iframe or inside an iframe embedded in a window with a different origin.\n\t * To distinguish if at one point the current execution environment is running inside a window with a different origin, see hasDifferentOriginAncestor()\n\t */\n\tpublic static getSameOriginWindowChain(): IWindowChainElement[] {\n\t\tif (!sameOriginWindowChainCache) {\n\t\t\tsameOriginWindowChainCache = [];\n\t\t\tlet w: Window | null = window;\n\t\t\tlet parent: Window | null;\n\t\t\tdo {\n\t\t\t\tparent = getParentWindowIfSameOrigin(w);\n\t\t\t\tif (parent) {\n\t\t\t\t\tsameOriginWindowChainCache.push({\n\t\t\t\t\t\twindow: w,\n\t\t\t\t\t\tiframeElement: w.frameElement || null\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tsameOriginWindowChainCache.push({\n\t\t\t\t\t\twindow: w,\n\t\t\t\t\t\tiframeElement: null\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tw = parent;\n\t\t\t} while (w);\n\t\t}\n\t\treturn sameOriginWindowChainCache.slice(0);\n\t}\n\n\t/**\n\t * Returns true if the current execution environment is chained in a list of iframes which at one point ends in a window with a different origin.\n\t * Returns false if the current execution environment is not running inside an iframe or if the entire chain of iframes have the same origin.\n\t */\n\tpublic static hasDifferentOriginAncestor(): boolean {\n\t\tif (!sameOriginWindowChainCache) {\n\t\t\tthis.getSameOriginWindowChain();\n\t\t}\n\t\treturn hasDifferentOriginAncestorFlag;\n\t}\n\n\t/**\n\t * Returns the position of `childWindow` relative to `ancestorWindow`\n\t */\n\tpublic static getPositionOfChildWindowRelativeToAncestorWindow(childWindow: Window, ancestorWindow: Window | null) {\n\n\t\tif (!ancestorWindow || childWindow === ancestorWindow) {\n\t\t\treturn {\n\t\t\t\ttop: 0,\n\t\t\t\tleft: 0\n\t\t\t};\n\t\t}\n\n\t\tlet top = 0, left = 0;\n\n\t\tconst windowChain = this.getSameOriginWindowChain();\n\n\t\tfor (const windowChainEl of windowChain) {\n\n\t\t\ttop += windowChainEl.window.scrollY;\n\t\t\tleft += windowChainEl.window.scrollX;\n\n\t\t\tif (windowChainEl.window === ancestorWindow) {\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (!windowChainEl.iframeElement) {\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tconst boundingRect = windowChainEl.iframeElement.getBoundingClientRect();\n\t\t\ttop += boundingRect.top;\n\t\t\tleft += boundingRect.left;\n\t\t}\n\n\t\treturn {\n\t\t\ttop: top,\n\t\t\tleft: left\n\t\t};\n\t}\n}\n\n/**\n * Returns a sha-256 composed of `parentOrigin` and `salt` converted to base 32\n */\nexport async function parentOriginHash(parentOrigin: string, salt: string): Promise<string> {\n\t// This same code is also inlined at `src/vs/workbench/services/extensions/worker/webWorkerExtensionHostIframe.html`\n\tif (!crypto.subtle) {\n\t\tthrow new Error(`'crypto.subtle' is not available so webviews will not work. This is likely because the editor is not running in a secure context (https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts).`);\n\t}\n\n\tconst strData = JSON.stringify({ parentOrigin, salt });\n\tconst encoder = new TextEncoder();\n\tconst arrData = encoder.encode(strData);\n\tconst hash = await crypto.subtle.digest('sha-256', arrData);\n\treturn sha256AsBase32(hash);\n}\n\nfunction sha256AsBase32(bytes: ArrayBuffer): string {\n\tconst array = Array.from(new Uint8Array(bytes));\n\tconst hexArray = array.map(b => b.toString(16).padStart(2, '0')).join('');\n\t// sha256 has 256 bits, so we need at most ceil(lg(2^256-1)/lg(32)) = 52 chars to represent it in base 32\n\treturn BigInt(`0x${hexArray}`).toString(32).padStart(52, '0');\n}\n"]}